<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
</head>

<% document ||= nil %>

<style>
    body {
        margin: 0;
        background-color: #F1F1F1;
        overflow: hidden;
        font-size: 1.6rem;
        min-height: 100dvh;
    }

    .page {
        height: 100%;
    }

    textarea {
        margin: 0;
        padding-top: 16px;
        padding-left: 16px;
        padding-right: 16px;
        width: 100vw;
        height: calc(100dvh - 80px);
        background-color: inherit;
        border: none;
        color: #181818;
        font-size: 1.6rem;
    }

    textarea:focus, textarea:active {
        outline: 0px !important;
        -webkit-appearance: none;
        box-shadow: none !important;
    }

    #bottom {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        width: 100vw;
        height: 64px;
        background-color: #181818;
        color: #F1F1F1;
    }

    #bottom > div {
        display: flex;
        height: 100%;
        align-items: center;
        padding: 0 16px;
    }

    #bottom .left {
        justify-content: left;
    }

    #bottom .middle {
        justify-content: center;
    }

    #bottom .right {
        justify-content: right;
    }
</style>

<body>
    <div class="page">
        <textarea id="body" name="body" placeholder="Write..."><%= document&.raw_content %></textarea>
        <div id="bottom">
            <div id="title" class="left"></div>
            <div id="char-count" class="middle"></div>
            <div id="notification" class="right"></div>
        </div>
    </div>
</body>

<script>
    let body_dom = document.getElementById('body')
    let title_dom = document.getElementById('title')
    let char_count_dom = document.getElementById('char-count')
    let notification_dom = document.getElementById('notification')

    let document_title = 'Untitled'
    title_dom.innerText = document_title

    let notify = (text) => {
        notification_dom.innerText = text
        setTimeout(() => { setTime() }, 3000)
    }

    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault()
            submitDocument()
        }
    })

    document.addEventListener('keyup', (e) => {
        char_count_dom.innerText = `${body_dom.value.length} characters`
    })

    let setTime = () => {
        notification_dom.innerText = new Date().toLocaleTimeString('en-GB', { 
            hour: '2-digit', minute: '2-digit', hour12: false 
        })
    }

    let clockWait = () => {
        setTime()
        setTimeout(() => { clockWait() }, 1000 * 60)
    }

    clockWait()

    let submitDocument = async () => {
        const data = {
            title: document_title,
            body: body_dom.value,
        }
        try {
            const response = await fetch('/write', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
            if (response.ok) {
                notify('Saved!')
            } else {
                notify('Failed!')
            }
        } catch (err) {
            notify('Error!')
            console.error(err)
        }
    }
</script>

</html>
