<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/write.css"> 
</head>

<% document ||= nil %>

<body>
    <div id="notification" class="page">
        Notice!
    </div>
    <form id="postForm">
        <div class="inline-fields">
            <input type="text" id="id" name="id" placeholder="ID" value="<%= document&.id %>">
            <input type="text" id="title" name="title" placeholder="Title" value="<%= document&.title %>">

            <div class="toggle-group">
                <label for="fragment">‚öò</label>
                <label class="toggle">
                    <input type="checkbox" id="fragment" name="fragment" <%= 'checked' if document&.is_fragment? %>>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="toggle-group">
                <label for="public">üëÅ</label>
                <label class="toggle">
                    <input type="checkbox" id="public" name="public" <%= 'checked' if document&.is_public? %>>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="page">
            <textarea id="body" name="body" placeholder="Write..."><%= document&.raw_content %></textarea>
        </div>
    </form>

    <script>
        let notify = (text) => {
            let notification_dom = document.getElementById('notification')
            notification_dom.innerText = text
            notification_dom.style.opacity = 1
            setTimeout(() => { notification_dom.style.opacity = 0 }, 3000)
        }

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('postForm').requestSubmit();
            }
        })

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            const data = {
                id: document.getElementById('id').value,
                title: document.getElementById('title').value,
                public: document.getElementById('public').checked,
                fragment: document.getElementById('fragment').checked,
                body: document.getElementById('body').value,
            }
            try {
                const response = await fetch('/write', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                })
                if (response.ok) {
                    notify('Submitted successfully.')
                } else {
                    notify('Submission failed.')
                }
            } catch (err) {
                notify('Error submitting post.')
                console.error(err)
            }
        })
    </script>
</body>
</html>
